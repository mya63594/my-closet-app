/* ===========================================================
  å®Œå…¨ç‰ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ â€” 2æ®µã®å††å½¢ãƒãƒ³ã‚¬ãƒ¼ãƒ¬ãƒ¼ãƒ« + é–‹é–‰æ¼”å‡º
  - èµ·å‹•æ™‚ã«æ‰‰ãŒã‚†ã£ãã‚Šä¸€åº¦ã ã‘é–‹ã
  - ç”»åƒè¿½åŠ  â†’ kindã§top/bottomæŒ‡å®š(ã¾ãŸã¯è‡ªå‹•åˆ¤å®š)
  - items ã¯ localStorage ã«ä¿å­˜
  - å„ãƒªãƒ³ã‚°ã¯ãƒ‰ãƒ©ãƒƒã‚°ã§å›è»¢ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—ã§æ¢ã™æ„Ÿè¦šï¼‰
  - ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã—ã¦ã‚³ãƒ¼ãƒ‡è¡¨ç¤º
=========================================================== */

const STORAGE_KEY = "my_closet_circle_v1";

/* state */
let items = []; // {id,image,category,season,material,kind,createdAt}
const topItems = () => items.filter(i=>i.kind==="top");
const bottomItems = () => items.filter(i=>i.kind==="bottom");

/* DOM refs */
const closet = document.getElementById("closet");
const addBtn = document.getElementById("addBtn");
const imageInput = document.getElementById("imageInput");
const categoryEl = document.getElementById("category");
const seasonEl = document.getElementById("season");
const materialEl = document.getElementById("material");
const kindEl = document.getElementById("kind");
const listEl = document.getElementById("list");
const topRing = document.getElementById("top-ring");
const bottomRing = document.getElementById("bottom-ring");
const selectedTopEl = document.getElementById("selected-top");
const selectedBottomEl = document.getElementById("selected-bottom");

/* load items from storage */
function loadItems(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    items = raw ? JSON.parse(raw) : [];
  }catch(e){
    items = [];
  }
}
function saveItems(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }catch{}
}

/* generate id */
function id(){ return "i_"+Math.random().toString(36).slice(2,9); }

/* startup */
window.addEventListener("load", ()=>{
  loadItems();
  renderAll();
  // èµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘ã‚†ã£ãã‚Šé–‹ã
  setTimeout(()=>{ closet.classList.add("open"); }, 900);
});

/* add handler */
addBtn.addEventListener("click", handleAdd);
function handleAdd(){
  if(!imageInput.files || !imageInput.files[0]){ alert("å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„"); return; }
  const file = imageInput.files[0];
  const reader = new FileReader();
  reader.onload = (e)=>{
    const dataUrl = e.target.result;
    const category = categoryEl.value;
    const season = seasonEl.value;
    const material = materialEl.value;
    let kind = kindEl.value;
    if(kind === "infer"){
      kind = (category==="ä»•äº‹"||category==="éŠã³") ? "top" : "bottom";
    }
    const newItem = { id: id(), image: dataUrl, category, season, material, kind, createdAt: Date.now() };
    items.unshift(newItem);
    saveItems();
    renderAll();
    imageInput.value = "";
  };
  reader.readAsDataURL(file);
}

/* render everything */
function renderAll(){
  renderList();
  renderRing(topRing, topItems());
  renderRing(bottomRing, bottomItems());
}

/* render management list */
function renderList(){
  listEl.innerHTML = "";
  if(items.length===0){
    listEl.innerHTML = `<div style="color:var(--muted);padding:10px">ã¾ã æœãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ¼ãƒ ã§å†™çœŸã‚’è¿½åŠ ã—ã¦ã­ã€‚</div>`;
    selectedTopEl.innerText = "ãƒˆãƒƒãƒ—ã‚¹: ã¾ã é¸ã°ã‚Œã¦ã„ã¾ã›ã‚“";
    selectedBottomEl.innerText = "ãƒœãƒˆãƒ ã‚¹: ã¾ã é¸ã°ã‚Œã¦ã„ã¾ã›ã‚“";
    return;
  }
  items.forEach(it=>{
    const row = document.createElement("div");
    row.className = "item";
    row.dataset.id = it.id;
    row.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px">
        <img src="${it.image}">
        <div style="min-width:140px">
          <div style="font-weight:700;color:#ffd8ff">${it.category} (${it.kind})</div>
          <div style="font-size:13px;color:var(--muted)">${it.season} / ${it.material}</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="delete-btn" title="å‰Šé™¤">ğŸ—‘ï¸</button>
      </div>
    `;
    row.querySelector(".delete-btn").addEventListener("click", ()=>{
      if(!confirm("ã“ã®æœã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      items = items.filter(x=>x.id!==it.id);
      saveItems();
      renderAll();
    });
    listEl.appendChild(row);
  });
}

/* render a circular ring */
function renderRing(ringEl, data){
  ringEl.innerHTML = "";
  const n = data.length;
  if(n===0){
    // show placeholder
    const placeholder = document.createElement("div");
    placeholder.style.position="absolute";
    placeholder.style.left="50%";
    placeholder.style.top="50%";
    placeholder.style.transform="translate(-50%,-50%)";
    placeholder.style.color="var(--muted)";
    placeholder.style.fontSize="14px";
    placeholder.innerText = "ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“";
    ringEl.appendChild(placeholder);
    return;
  }

  // radius based on ring size
  const rect = ringEl.getBoundingClientRect();
  const radius = Math.min(rect.width, rect.height)/2 - 50; // keep some margin
  data.forEach((it, idx)=>{
    const ang = (360 / n) * idx; // degrees
    const rad = ang * Math.PI / 180;
    const x = Math.cos(rad) * radius;
    const y = Math.sin(rad) * radius * 0.55; // squash vertically for elliptical look
    const item = document.createElement("div");
    item.className = "ring-item";
    item.style.transform = `translate(${x}px, ${y}px) rotate(${ang}deg)`;
    item.innerHTML = `<img src="${it.image}" alt=""><div class="cap">${it.category}</div>`;
    // clicking selects
    item.addEventListener("click", ()=> selectById(it.id));
    ringEl.appendChild(item);
  });
}

/* selection */
function selectById(idVal){
  const it = items.find(x=>x.id===idVal);
  if(!it) return;
  if(it.kind==="top"){
    selectedTopEl.innerHTML = `<img src="${it.image}" alt=""><div style="font-size:13px;color:var(--muted);margin-top:6px">${it.category}</div>`;
  } else {
    selectedBottomEl.innerHTML = `<img src="${it.image}" alt=""><div style="font-size:13px;color:var(--muted);margin-top:6px">${it.category}</div>`;
  }
}

/* =========================
   rotation (drag to rotate)
   We rotate the entire ring container by adjusting transform: rotate(...)
   and keep track of pointer movement.
   ========================= */

setupRingRotation(topRing);
setupRingRotation(bottomRing);

function setupRingRotation(ringEl){
  let isDown = false;
  let startX=0;
  let startRot = 0;

  // use data-rotation attribute on ringEl to persist rotation
  ringEl.dataset.rotation = ringEl.dataset.rotation || "0";

  const onPointerDown = (e) => {
    isDown = true;
    startX = (e.touches ? e.touches[0].clientX : e.clientX);
    startRot = parseFloat(ringEl.dataset.rotation) || 0;
    ringEl.style.transition = "none";
    e.preventDefault();
  };

  const onPointerMove = (e) => {
    if(!isDown) return;
    const x = (e.touches ? e.touches[0].clientX : e.clientX);
    const dx = x - startX;
    // sensitivity factor
    const deltaDeg = dx * 0.25;
    const newRot = startRot + deltaDeg;
    ringEl.dataset.rotation = newRot;
    ringEl.style.transform = `translate(-50%,-50%) rotate(${newRot}deg)`;
  };

  const onPointerUp = (e) => {
    if(!isDown) return;
    isDown = false;
    ringEl.style.transition = "transform .4s cubic-bezier(.2,.8,.2,1)";
    // snap to nearest item angle optionally (not implemented: keeps free rotation)
  };

  // pointer events
  ringEl.addEventListener("mousedown", onPointerDown);
  window.addEventListener("mousemove", onPointerMove);
  window.addEventListener("mouseup", onPointerUp);

  // touch
  ringEl.addEventListener("touchstart", onPointerDown, {passive:false});
  window.addEventListener("touchmove", onPointerMove, {passive:false});
  window.addEventListener("touchend", onPointerUp);
}

/* helpers: re-render rings on resize so radius calc updated */
window.addEventListener("resize", ()=>{ renderRing(topRing, topItems()); renderRing(bottomRing, bottomItems()); });
